<!DOCTYPE html>
<html lang="es">
     <head>
          <meta charset="utf-8" />
          <meta http-equiv="X-UA-Compatible" content="IE=edge" />
          <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

          <title>Nombre del Sistema</title>
          <link rel="icon" type="image/png" href="img/working.png">
          
          <!-- ESTILOS DEL MENU -->
          <link href="menu/styles.css" rel="stylesheet" />
        
          <!-- BOOTSTRAP ICONS -->
          <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">

          <!-- DATATABLES -->
          <link rel="stylesheet" href="dt/datatables.min.css">
          <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
          <link rel="stylesheet" href="dt/buttons.dataTables.min.css">

          <!-- ALERTIFYJS -->
          <link rel="stylesheet" href="alert/alertify.min.css">
          <link rel="stylesheet" href="alert/themes/default.min.css">
          <script src="alert/alertify.min.js"></script>
          
     </head>
     <body class="sb-nav-fixed">
          <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
               <!-- Navbar Brand-->
               <a class="navbar-brand ps-3" href="menu.html">Start Bootstrap</a>
               <!-- Sidebar Toggle-->
               <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="bi bi-list"></i></button>
               <!-- Navbar Search-->
               <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
                    <div class="input-group">
                         <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />
                         <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="bi bi-search"></i></button>
                    </div>
               </form>
               <!-- Navbar-->
               <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                         <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                         <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                         <li><a class="dropdown-item" href="#!">Settings</a></li>
                         <li><a class="dropdown-item" href="#!">Activity Log</a></li>
                         <li><hr class="dropdown-divider" /></li>
                         <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                         </ul>
                    </li>
               </ul>
          </nav>
          <div id="layoutSidenav">
               <div id="layoutSidenav_nav">
                    <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                         <div class="sb-sidenav-menu">
                         <div class="nav">
                              <div class="sb-sidenav-menu-heading">Core</div>
                              <a class="nav-link" href="menu.html">
                                   <div class="sb-nav-link-icon"><i class="bi bi-speedometer"></i></div>
                                   Dashboard
                              </a>
                              <div class="sb-sidenav-menu-heading">Interface</div>
                              <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLayouts" aria-expanded="false" aria-controls="collapseLayouts">
                                   <div class="sb-nav-link-icon"><i class="bi bi-columns-gap"></i></div>
                                   Mantenimiento
                                   <div class="sb-sidenav-collapse-arrow"><i class="i bi-chevron-down"></i></div>
                              </a>
                              <div class="collapse" id="collapseLayouts" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                                   <nav class="sb-sidenav-menu-nested nav">
                                        <a class="nav-link" href="usuarios.html">Usuarios</a>
                                        <a class="nav-link" href="">Light Sidenav</a>
                                   </nav>
                              </div>
                              
                              <!-- MENU COMPRAS -->
                              <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePages" aria-expanded="false" aria-controls="collapsePages">
                                   <div class="sb-nav-link-icon"><i class="bi bi-basket"></i></div>
                                   Compras
                                   <div class="sb-sidenav-collapse-arrow"><i class="i bi-chevron-down"></i></div>
                              </a>

                              <div class="collapse" id="collapsePages" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                                   <nav class="sb-sidenav-menu-nested nav">
                                       <a class="nav-link" href="compras.html"><i class="bi bi-basket2 me-2"></i> Registrar compras</a>
                                   </nav>
                               </div>

                              <div class="collapse" id="collapsePages" aria-labelledby="headingTwo" data-bs-parent="#sidenavAccordion">
                                   <nav class="sb-sidenav-menu-nested nav accordion" id="sidenavAccordionPages">
                                        <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#pagesCollapseAuth" aria-expanded="false" aria-controls="pagesCollapseAuth">
                                             Authentication
                                             <div class="sb-sidenav-collapse-arrow"><i class="i bi-chevron-down"></i></div>
                                        </a>
                                        <div class="collapse" id="pagesCollapseAuth" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordionPages">
                                             <nav class="sb-sidenav-menu-nested nav">
                                             <a class="nav-link" href="">Login</a>
                                             <a class="nav-link" href="">Register</a>
                                             <a class="nav-link" href="">Forgot Password</a>
                                             </nav>
                                        </div>
                                        <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#pagesCollapseError" aria-expanded="false" aria-controls="pagesCollapseError">
                                             Error
                                             <div class="sb-sidenav-collapse-arrow"><i class="i bi-chevron-down"></i></div>
                                        </a>
                                        <div class="collapse" id="pagesCollapseError" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordionPages">
                                             <nav class="sb-sidenav-menu-nested nav">
                                             <a class="nav-link" href="">401 Page</a>
                                             <a class="nav-link" href="">404 Page</a>
                                             </nav>
                                        </div>
                                   </nav>
                              </div>
                              <div class="sb-sidenav-menu-heading">Addons</div>
                              <a class="nav-link" href="">
                                   <div class="sb-nav-link-icon"><i class="bi bi-bar-chart"></i></div>
                                   Charts
                              </a>
                              <a class="nav-link" href="">
                                   <div class="sb-nav-link-icon"><i class="bi bi-table"></i></div>
                                   Tables
                              </a>
                         </div>
                         </div>
                         <div class="sb-sidenav-footer">
                         <div class="small">Iniciado por:</div>
                         <div id="usuario"></div>
                         </div>
                    </nav>
               </div>
               
               <div id="layoutSidenav_content">
                         <!-- AQUÍ VA TODO LO QUE SE VA A VISUALIZAR EN LA PÁGINA -->
                         <!-- CUERPO DEL DASHBOARD -->
                    <main>
                         <div class="container-fluid px-4">
                              <h1 class="mt-2">Usuarios</h1>
                              <div class="row">
                                   <table id="tabla_usuarios" class="display compact" style="width:100%">
                                        <thead>
                                             <tr>
                                                  <th>Id Usuario</th>
                                                  <th>N° Cédula</th>
                                                  <th>Nombre</th>
                                                  <th>Celular</th>
                                                  <th>Usuario</th>
                                                  <th>Contraseña</th>
                                                  <th>Acciones</th>
                                             </tr>
                                        </thead>

                                   </table>

                              </div>
                         </div>
                    </main>
                    <footer class="py-4 bg-light mt-auto">
                         <div class="container-fluid px-4">
                         <div class="d-flex align-items-center justify-content-between small">
                              <div class="text-muted">Copyright &copy; Your Website 2025</div>
                              <div>
                                   <a href="#">Privacy Policy</a>
                                   &middot;
                                   <a href="#">Terms &amp; Conditions</a>
                              </div>
                         </div>
                         </div>
                    </footer>
               </div>
          </div>
        
     <!-- Modal Nuevo Usuario -->
     <div class="modal fade" id="modalNuevoUsuario" tabindex="-1" aria-labelledby="modalUsuarioLabel" aria-hidden="true" data-bs-backdrop="static">
          <div class="modal-dialog">
               <form id="formNuevoUsuario" class="modal-content">
                    <div class="modal-header">
                         <h5 class="modal-title" id="modalUsuarioLabel">Agregar Nuevo Usuario</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                         <div class="mb-2">
                              <label class="form-label">N° Cédula</label>
                              <input type="number" id="cedula" class="form-control" required min="1000000" max="9999999">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Nombre completo</label>
                              <input type="text" id="nombre" class="form-control text-uppercase" required minlength="6" maxlength="50">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Celular</label>
                              <input type="text" id="celular" class="form-control" required minlength="6" maxlength="12">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Usuario</label>
                              <input type="text" id="txtusuario" class="form-control" required minlength="5" maxlength="30">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Contraseña</label>
                              <input type="text" id="contrasena" class="form-control" required minlength="5" maxlength="30">
                         </div>
                    </div>
                    <div class="modal-footer">
                         <button type="reset" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                         <button type="submit" class="btn btn-primary">Guardar Usuario</button>
                    </div>
               </form>
          </div>
     </div>

     <!-- Modal Editar Usuario -->
     <div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalEditarUsuarioLabel" aria-hidden="true" data-bs-backdrop="static">
          <div class="modal-dialog">
               <form id="formEditarUsuario" class="modal-content">
                    <div class="modal-header">
                         <h5 class="modal-title" id="modalEditarUsuarioLabel">Editar Usuario</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                         <input type="hidden" id="edit_idusuario">
                         <div class="mb-2">
                              <label class="form-label">N° Cédula</label>
                              <input type="number" id="edit_cedula" class="form-control" required min="1000000" max="9999999">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Nombre completo</label>
                              <input type="text" id="edit_nombre" class="form-control text-uppercase" required minlength="6" maxlength="50">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Celular</label>
                              <input type="text" id="edit_celular" class="form-control" required minlength="6" maxlength="12">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Usuario</label>
                              <input type="text" id="edit_usuario" class="form-control" required minlength="5" maxlength="30">
                         </div>
                         <div class="mb-2">
                              <label class="form-label">Contraseña</label>
                              <input type="text" id="edit_contrasena" class="form-control" required minlength="5" maxlength="30">
                         </div>
                    </div>
                    <div class="modal-footer">
                         <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                         <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
               </form>
          </div>
     </div>
   



          <script src="js/funcionesSistema.js"></script>
          <!-- MENU -->
          <script src="menu/bootstrap.bundle.min.js"></script>
          <script src="menu/scripts.js"></script>
          <!-- DATATABLES -->
          <script src="dt/jquery-3.7.1.js"></script>
          <script src="dt/datatables.min.js"></script>
          <script src="dt/jquery.dataTables.min.js"></script>
          <!-- DATATABLES Buttons extension -->
          <script src="dt/dataTables.buttons.min.js"></script>
          <script src="dt/buttons.print.min.js"></script>
          <script src="dt/buttons.html5.min.js"></script>
          <!-- DATATABLES JSZip y pdfmake para exportar -->
          <script src="dt/jszip.min.js"></script>
          <script src="dt/pdfmake.min.js"></script>
          <script src="dt/vfs_fonts.js"></script>
          <!-- DATATABLES Idioma Español -->
          <script src="dt/es-ES.js"></script>

          <script>
               //Al cargarse la página---------------------------------------------------------------------------
               //Control de seguridad en la apertura de la página------------------------------------------------
               var nom = localStorage.getItem("nomUsuario");
               if (nom == "" || nom == null){
                    window.location.href = "error.html"; // Redirige al login
               }else{
                    document.getElementById("usuario").innerHTML = nom;
               }
               //Fin del Control de seguridad en la apertura de la página----------------------------------------
               
               //------------------------------------------------------------------------------------------------
               // Recuperar el array de objetos desde localStorage
               var usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];

               let tabla;
               const modalNUsuario = new bootstrap.Modal(document.getElementById('modalNuevoUsuario'));

               document.addEventListener('DOMContentLoaded', function () {
                    cargarTablaUsuarios();

                    //Evento para Nuevo Usuario----------------------------------------------------------
                    document.getElementById('formNuevoUsuario').addEventListener('submit', function (e) {
                         e.preventDefault();

                         const nuevoUsuario = {
                              idusuario: obtenerSiguienteId(usuarios),
                              cedula: document.getElementById('cedula').value.trim(),
                              nombre: document.getElementById('nombre').value.trim().toUpperCase(),
                              celular: document.getElementById('celular').value.trim(),
                              usuario: document.getElementById('txtusuario').value.trim(),
                              contrasena: document.getElementById('contrasena').value.trim()
                         };

                         if (Object.values(nuevoUsuario).some(val => val === '')) {
                              alert('Todos los campos son obligatorios');
                              return;
                         }

                         usuarios.push(nuevoUsuario);
                         guardarUsuarios(usuarios);
                         this.reset();
                         tabla.row.add(nuevoUsuario).draw();
                         modalNUsuario.hide();
                         alertify.success("Registro guardado");
                    });

                 
                    const modalEUsuario = new bootstrap.Modal(document.getElementById('modalEditarUsuario'));
                    // Evento para botón editar--------------------------------------------------------------
                    document.addEventListener('click', function (e) {
                         if (e.target.closest('.btn-editar')) {
                              const id = parseInt(e.target.closest('.btn-editar').dataset.id);
                              const usuario = usuarios.find(u => u.idusuario === id);
                              if (usuario) {
                                   document.getElementById('edit_idusuario').value = usuario.idusuario;
                                   document.getElementById('edit_cedula').value = usuario.cedula;
                                   document.getElementById('edit_nombre').value = usuario.nombre;
                                   document.getElementById('edit_celular').value = usuario.celular;
                                   document.getElementById('edit_usuario').value = usuario.usuario;
                                   document.getElementById('edit_contrasena').value = usuario.contrasena;
                                   modalEUsuario.show();
                              }
                         }
                    });

                    // Guardar cambios al editar-----------------------------------------------------------
                    document.getElementById('formEditarUsuario').addEventListener('submit', function (e) {
                         e.preventDefault();
                         const id = parseInt(document.getElementById('edit_idusuario').value);
                         const index = usuarios.findIndex(u => u.idusuario === id);
                         if (index !== -1) {
                              usuarios[index] = {
                                   idusuario: id,
                                   cedula: document.getElementById('edit_cedula').value.trim(),
                                   nombre: document.getElementById('edit_nombre').value.trim().toUpperCase(),
                                   celular: document.getElementById('edit_celular').value.trim(),
                                   usuario: document.getElementById('edit_usuario').value.trim(),
                                   contrasena: document.getElementById('edit_contrasena').value.trim()
                              };
                              guardarUsuarios(usuarios);
                              tabla.clear().rows.add(usuarios).draw();
                              modalEUsuario.hide();
                              alertify.success("Usuario actualizado");
                         }
                    });

                    // Evento para botón eliminar
                    document.addEventListener('click', function (e) {
                         if (e.target.closest('.btn-eliminar')) {
                              const id = parseInt(e.target.closest('.btn-eliminar').dataset.id);
                              alertify.confirm("Eliminar usuario", "¿Estás seguro de eliminar este usuario?",
                                   function(){
                                        usuarios = usuarios.filter(u => u.idusuario !== id);
                                        guardarUsuarios(usuarios);
                                        tabla.clear().rows.add(usuarios).draw();
                                        alertify.success("Usuario eliminado");
                                   },
                                   function(){
                                        alertify.error("Eliminación cancelada");
                                   }
                              ).set('labels', {ok:'Sí', cancel:'No'});
                         }
                    });
               });
               //------------------------------------------------------------------------------
               function cargarTablaUsuarios(){
                    // Inicializar el DataTable
                    tabla = new DataTable("#tabla_usuarios", {
                         data: usuarios,
                         columns: [
                              { data: 'idusuario', title: 'Id Usuario' },
                              { data: 'cedula', title: 'N° Cédula' },
                              { data: 'nombre', title: 'Nombre' },
                              { data: 'celular', title: 'Celular' },
                              { data: 'usuario', title: 'Usuario' },
                              { data: 'contrasena', title: 'Contraseña' },
                              {
                                   data: null,
                                   render: function (data, type, row) {
                                   return `
                                        <button class="btn btn-sm btn-warning me-1 btn-editar" data-id="${row.idusuario}"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-danger btn-eliminar" data-id="${row.idusuario}"><i class="bi bi-trash"></i></button>
                                   `;
                                   }
                              }
                         ],
                         dom: 'Bfrtip',
                         buttons: [
                              {
                                   extend: 'print',
                                   text: '<i class="bi bi-printer"></i> Imprimir'
                              },
                              {
                                   extend: 'excelHtml5',
                                   text: '<i class="bi bi-filetype-xlsx"></i> Exportar a Excel'
                              },
                              {
                                   extend: 'pdfHtml5',
                                   text: '<i class="bi bi-filetype-pdf"></i> Exportar a PDF',
                                   exportOptions: {
                                        columns: [0, 1, 2, 3, 4, 5] // Excluye columna de acciones (índice 6)
                                   },
                                   customize: function (doc) {
                                        // Verifica si `content` tiene una tabla definida
                                        for (let i = 0; i < doc.content.length; i++) {
                                             if (doc.content[i].table !== undefined) {
                                                  const tableNode = doc.content[i];

                                                  // Si hay body, ajustamos los anchos
                                                  if (tableNode.table.body && tableNode.table.body.length > 0) {
                                                       const colCount = tableNode.table.body[0].length;
                                                       tableNode.table.widths = Array(colCount).fill('*');
                                                  }

                                                  break; // salimos del loop luego de encontrar la tabla
                                             }
                                        }
                                   }
                              },
                              {
                                   text: '<i class="bi bi-file-earmark-plus"></i> Nuevo usuario',
                                   className: 'btn btn-sm btn-primary',
                                   action: function (e, dt, node, config) {
                                        // Abrir un modal para crear un nuevo usuario
                                        $('#modalNuevoUsuario').modal('show');
                                   }
                              }
                         ],
                         responsive: true,
                         language: spanish,
                         initComplete: function () {
                              // Aplicar clases de Bootstrap a los botones
                              $('.dt-button:contains("Nuevo usuario")')
                                   .removeClass('dt-button') // elimina estilo por defecto
                                   .addClass('btn btn-sm btn-primary'); // agrega estilos Bootstrap

                              $('.dt-button:contains("Imprimir")')
                                   .removeClass('dt-button')
                                   .addClass('btn btn-sm btn-info');

                              $('.dt-button:contains("Exportar a Excel")')
                                   .removeClass('dt-button')
                                   .addClass('btn btn-sm btn-success');

                              $('.dt-button:contains("Exportar a PDF")')
                                   .removeClass('dt-button')
                                   .addClass('btn btn-sm btn-danger');
                         }
                    });
                    //tabla.column(5).visible(false); //Ocultar la columna contraseña
               }
               //------------------------------------------------------------------------------
               function guardarUsuarios(data) {
                    localStorage.setItem('usuarios', JSON.stringify(data));
               }
               //------------------------------------------------------------------------------
               function obtenerSiguienteId(usuarios) {
                    if (usuarios.length === 0){
                         return 1;
                    }else{
                         const maxId = Math.max(...usuarios.map(u => u.idusuario || 0));
                         return maxId + 1;
                    }
               }
               //------------------------------------------------------------------------------
          </script>
    </body>
</html>
